# Vulnerability PoC Execution Guide

This guide provides step-by-step instructions for running multi-turn inference with the Tool Server.

## Prerequisites

Before starting, ensure you have:
- Git installed and repository cloned
- Python environment manager (uv) installed

## Environment Setup

### 1. Tool Server + VMS Environment

```bash
bash setup-tool-server-env-on-gcp.sh
```

### 2. VERL Tool + VERL Environment

```bash
# Initialize and update git submodules
git submodule update --init --recursive

# Create and activate virtual environment using uv
uv sync
source .venv/bin/activate

# Install dependencies
uv pip install -e verl
uv pip install -e ".[vllm,acecoder,torl]"
uv pip install "flash-attn<2.8.0" --no-build-isolation
```

## Data Preprocessing

Process the dataset by running:

```bash
python examples/data_preprocess/vulnerability_poc_execution.py \
    --bundle_name oracle_hypotheses_o4_mini \
    --out_path ~/data/vulnerability_poc_execution/oracle_hypotheses_o4_mini.parquet
```

## Running Services

### 1. Tool Server

```bash
# Activate tool server environment
source tool-server/bin/activate

# Start the tool server
python -m verl_tool.servers.serve \
    --tool_type vms_shell_tool \
    --port 5500

# Run tool server tests
pytest verl_tool/servers/tests/test_vms_shell_tool.py
```

### 2. Eval Server

```bash
# Activate VERL tool environment
source .venv/bin/activate

# Start the eval server
python eval_service/app.py \
    --tool-server-url http://0.0.0.0:5500/get_observation \
    --model Qwen/Qwen3-0.6B \
    --max_turns 20 \
    --min_turns 0 \
    --max_model_len 30000 \
    --enable_mtrl True \
    --mtrl_tool_indicator_token "<shell_tool>"

# Run eval server tests
python eval_service/test/test_rollout_vms_shell.py \
    --model_name Qwen/Qwen3-0.6B \
    --base_url http://0.0.0.0:8000
```

## Running Inference

To run inference against the preprocessed dataset:

```bash
python eval_service/scripts/evaluate_vulnerability_dataset.py \
    --dataset_path ~/data/vulnerability_poc_execution/oracle_hypotheses_o4_mini.parquet \
    --output_dir ~/eval_results/vulnerability_poc_execution/oracle_hypotheses_o4_mini_results \
    --base_url http://0.0.0.0:8000
```
